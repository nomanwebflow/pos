// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User Roles: SUPER_ADMIN, SELLER, STOCK_MANAGER, FINANCE, OWNER
enum UserRole {
  SUPER_ADMIN
  CASHIER
  STOCK_MANAGER
  OWNER
}

enum PaymentMethod {
  CASH
  CARD
  MIXED
}

enum StockMovementType {
  SALE
  REFILL
  ADJUSTMENT
  REFUND
}

enum RefundType {
  FULL
  PARTIAL
}

enum RefundStatus {
  NONE
  PARTIAL
  FULL
}

// Business/Store Configuration
model Business {
  id              String   @id @default(cuid())
  name            String
  address         String?
  phone           String?
  email           String?
  taxNumber       String?
  currency        String   @default("MUR")
  taxRate         Float    @default(15.0) // VAT for Mauritius
  refundTimeLimit Int?     @default(30) // Days allowed for refunds (null = unlimited)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users             User[]
  products          Product[]
  productCategories ProductCategory[]
  sales             Sale[]
  customers         Customer[]
  settings          Settings[]
  refunds           Refund[]
}

// User Management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  role          UserRole  @default(CASHIER)
  isActive      Boolean   @default(true)
  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sales         Sale[]
  stockMovements StockMovement[]
  auditLogs     AuditLog[]
  refunds       Refund[]

  @@index([businessId, role])
  @@index([businessId, isActive])
}

// Product Categories
model ProductCategory {
  id          String    @id @default(cuid())
  name        String
  description String?
  isActive    Boolean   @default(true)
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([businessId, name])
}

// Product & Inventory
model Product {
  id              String    @id @default(cuid())
  name            String
  sku             String    // Removed @unique to allow per-business SKUs
  barcode         String?   @unique
  imageUrl        String?
  description     String?
  category        String?
  costPrice       Float?
  sellingPrice    Float
  stockLevel      Int       @default(0)
  lowStockThreshold Int     @default(10)
  taxable         Boolean   @default(true)
  isActive        Boolean   @default(true)
  businessId      String
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  saleItems       SaleItem[]
  stockMovements  StockMovement[]
  refundItems     RefundItem[]

  @@unique([businessId, sku]) // SKU unique per business
  @@index([businessId, isActive])
  @@index([businessId, category])
  @@index([barcode])
}

// Customer Management
model Customer {
  id              String    @id @default(cuid())
  name            String
  email           String?
  phone           String?
  address         String?
  taxNumber       String?
  notes           String?
  isActive        Boolean   @default(true)
  businessId      String
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  sales           Sale[]

  @@index([businessId, isActive])
  @@index([email])
  @@index([phone])
}

// Sales Transaction
model Sale {
  id              String        @id @default(cuid())
  saleNumber      String        @unique
  subtotal        Float
  taxAmount       Float
  discount        Float         @default(0)
  total           Float
  paymentMethod   PaymentMethod
  cashReceived    Float?
  cashChange      Float?
  cardAmount      Float?
  notes           String?
  customerId      String?
  customer        Customer?     @relation(fields: [customerId], references: [id])
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  businessId      String
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  refundStatus    RefundStatus  @default(NONE)
  totalRefunded   Float         @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  saleItems       SaleItem[]
  refunds         Refund[]

  @@index([businessId, createdAt])
  @@index([businessId, userId])
  @@index([customerId])
}

// Sale Line Items
model SaleItem {
  id               String   @id @default(cuid())
  saleId           String
  sale             Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId        String
  product          Product  @relation(fields: [productId], references: [id])
  quantity         Int
  unitPrice        Float
  subtotal         Float
  taxAmount        Float
  total            Float
  quantityRefunded Int      @default(0)
  createdAt        DateTime @default(now())

  @@index([saleId])
  @@index([productId])
}

// Stock Movement Tracking
model StockMovement {
  id              String            @id @default(cuid())
  type            StockMovementType
  productId       String
  product         Product           @relation(fields: [productId], references: [id])
  quantity        Int
  previousStock   Int
  newStock        Int
  reference       String?           // Reference number for refills/adjustments
  reason          String?           // Required for adjustments
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  createdAt       DateTime          @default(now())

  @@index([productId])
  @@index([type])
}

// Settings
model Settings {
  id              String   @id @default(cuid())
  key             String
  value           String
  businessId      String
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([businessId, key])
}

// Audit Log for tracking actions
model AuditLog {
  id              String   @id @default(cuid())
  action          String
  entity          String
  entityId        String
  details         String?
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  createdAt       DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
}

// Refund Transaction
model Refund {
  id              String        @id @default(cuid())
  refundNumber    String        @unique
  saleId          String
  sale            Sale          @relation(fields: [saleId], references: [id])
  refundType      RefundType
  subtotal        Float
  taxAmount       Float
  total           Float
  paymentMethod   PaymentMethod
  reason          String
  notes           String?
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  businessId      String
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  refundItems     RefundItem[]

  @@index([businessId, createdAt])
  @@index([saleId])
  @@index([userId])
}

// Refund Line Items
model RefundItem {
  id               String   @id @default(cuid())
  refundId         String
  refund           Refund   @relation(fields: [refundId], references: [id], onDelete: Cascade)
  saleItemId       String
  productId        String
  product          Product  @relation(fields: [productId], references: [id])
  quantityRefunded Int
  unitPrice        Float
  subtotal         Float
  taxAmount        Float
  total            Float
  createdAt        DateTime @default(now())

  @@index([refundId])
  @@index([productId])
}
